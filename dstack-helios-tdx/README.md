# P2P Dstack Network of Helios Nodes

## TEE and light clients? 

Read the writeup [here](#).

## Replication

All communications are carried through the `/overlay` library, a stripped down version of the networking layer we're working on internally. The goal for our nodes is to replicate to be able to sign messages under the shared dstack public key. This public key emerges as a result of local choices of the TEE operator when joining the network rather than inferred by a bootstrap contract. 

> NB: we're not necessarily advocating for dstack nodes to infer the cluster they want to join based on operator choices. This is an experiment.

When a node is spinned up without specifying peers it assumes it's being bootstrapped and creates it own view of the dstack newtork. Other peers can now be spinned up and join the bootstrapped node.

When they request to join the bootsrapped node a P2P connection over QUIC is established between the two peers as follows:

```
Peer wants to join bootstrap B_0 -> Peer establishes connection with B_0.
Both nodes send their attestation paired with their local pubkey -> mutual authentication happens
|-> mutual authentication establishes a secure encrypted communication channel between the two nodes. 
|-> during mutual authentication the two nodes establish a session key used as base for the nonce. The session key is simply the highest value between two values randomly generated by both peers (NB: both peers are already attested at this point).

The peers now communicate over the encrypted p2p channel.
```

Among other things, this approach ensures that applications where various TEEs work together to achieve a unified application state on the leader TEE don't necessarily share the same level of authentication because the communication channels are p2p and not shared across the dstack nodes. By caching the shared cipher this doesn't add overhead. 

> NB: there's situations where the overlay will want to share with multiple TEEs of the same authorization group. In such situations sharing a secret across authorization groups can be beneficial for networking workload on the encryption; on the full implementation we reserve a message type for this.

> NB: replication is currently not safe as it's not checking measurements. This is fairly trivial to add once we employ a structured way of replicating os measurements. Hopefully we would be using something like https://github.com/kvinwang/dstack-mr.

# A meta-dstack note

As you'll learn when applying what is instructed in the `meta-dstack-patch`, this very first example relies on the app logic being within the TEE and there is a minimal abstraction over environment variables to have measurements be easily reproducible. The reason is because we don't expect to be maintaining the base TEE dstack image ourselves so haven't do much work on enabling virtualization and a more structured approach to measurements like splitting app and system measurements. 

## Modularization

This implementation is currently reliant on the `mock` crate to get the quote. If we were to virtualize the application we would simply have the mock function interact with the hopefully modular (i.e can choose which features to have, with the minimal being getting quotes) guest backend instead of interacting with tsm directly. 

# Build and use

See [meta-dstack-patch](./meta-dstack-patch/README.md) to build and deploy the dstack light client image.

Once the image is deployed and running in a TD, we can setup the node (the `execution_rpc` can also be alchemy or other RPCs that support `eth_getBlockReceipts` and `eth_getProof`):

```
curl -X POST http://nodepublicaddress:40080/setup \
     -H "Content-Type: application/json" \
     -d '{"peers": [], "port": 5000, "execution_rpc": "https://mainnet.infura.io/v3/XX"}'

{"status":"success"}
```

Now we wait for the client to sync and then we can start using the API:

## Getting last block in optimistic view

```
$ curl -X GET http://nodepublicaddress:3032/block

Example response:

"{\"signature\":\"4760854a048d2e62f85cf2652958409ba46ce307f8ca41feada8b7464e229fff0dc7f6b6de1e5e406af5d20d8fb18bb3d92e7c6303cacc085757199f6e8b6eb1\",\"blocknum\":\"22168277\"}"
```

## Call

Call `totalSupply()` on DAI (`0x6b175474e89094c44da98b954eedeac495271d0f`):

```
curl -X POST -H "Content-Type: application/json" http://nodepublicaddress:3032/call -d '{
  "to": "0x6b175474e89094c44da98b954eedeac495271d0f",
  "input": "0x18160ddd"
}'

Example response:

"{\"signature\":\"afee82102dba058189b389597ed13c01d77c307d5fbd3a49cc05860656af39b948454e33ecf6fee4963b3945e1d8370817157b5dc3d977b70879dbbdf8a5aa1f\",\"response\":{\"Success\":\"0x00000000000000000000000000000000000000000a4ef33decf96b6a14d0901d\"}}"
```

## Getting attestation

```
$ curl -X GET http://nodepublicaddress:3032/attest

Example response:

"{\"quote\":\"040002008100000000000000939a7233f79c4ca9940a0db3957f0607000000000000000000000000000000000000000008010800000000000000000000000000bfb360ac8e6233a1bca1433caf7382d95c165b4a77fb00bf1435e5a08f300cdfead5ee68461afd9b6c728dce7534602d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e7000600000000002a90c8fa38672cafd791d994beb6836b99383b2563736858632284f0f760a6446efd1e7ec457cf08b629ea630f7b45250000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003300980705adf09d28b707b79699d9874892164280832be2c386a715b6e204e0897fb564a064f810659207ba862b304f54d84a731598cdc0700f2e6c6d501a9b0f1d807d848a3bf87939a2dd42d336361e36580bc27cf5e86ab3a2b32bee7cb295cf67e80d396894ea33a7e8a7dfe9c53dc0dd074cfe06928ebfb16ce5d1b7c5faa3f7993bcc9da88532f792421e52f600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000089ec5e2361b38468a4cc543823d1ade75a049dc7de653bdb161f98585f29157f0000000000000000000000000000000000000000000000000000000000000000cf100000a74745df947363a314e76ebef4b4d2b341b072826b5b8fefdf1792b492373f6eaf41f68d01c35bcef371112d3aa3a974caf0e86d15a855403f0cc956bd0392f30cdf91b2eef3ff452874677772180d80de1c33cd9cbde445ddbb1959b7f6cfa17aa09c55ca29286d00e073d7226714582fc741f5b10b9590092175c54f35cb3c0600491000000808ff1b04ff0006000000000000000000000000000000000000000000000000000000000000000000000000000000001500000000000000e700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c50000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000048c578bd4fef23d99d9efb35f0626dec61f5b35b8f2e2ba15ad22f278db77d5800000000000000000000000000000000000000000000000000000000000000007bc03ac296c3ecb9170b84ef24297bdbfa8cdc41f9aabdbd920f34ecb3297b8fe2d88cafd39b4a5a010cfdb31b46bdfbc8e51f23bf5aa15f0e4770beb5c0479f200000000000000000000000000000000000000000000000000000000000000000000500610e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d494945386a4343424a65674177494241674956414c615073646e6a3574336b353747685254724d75372f524f567a644d416f4743437147534d343942414d430a4d484178496a416742674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d0a45556c756447567349454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155450a4341774351304578437a414a42674e5642415954416c56544d423458445449314d4449774e4441304d6a497a4d566f5844544d794d4449774e4441304d6a497a0a4d566f77634445694d434147413155454177775a535735305a5777675530645949464244537942445a584a3061575a70593246305a5445614d426747413155450a43677752535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d517377435159440a5651514944414a445154454c4d416b474131554542684d4356564d775754415442676371686b6a4f5051494242676771686b6a4f50514d4242774e43414152450a2b30542f735a6350744667634f596775515969384943626171356c5734355a50663577444a64784a442b304a6369412b62414f744576323553572f424d354d370a6c74716755336a4f6e556853556f4b43413357576f3449444444434341776777487759445652306a42426777466f41556c5739647a62306234656c4153636e550a3944504f4156634c336c5177617759445652306642475177596a42676f46366758495a616148523063484d364c79396863476b7564484a316333526c5a484e6c0a636e5a705932567a4c6d6c75644756734c6d4e766253397a5a3367765932567964476c6d61574e6864476c76626939324e4339775932746a636d772f593245390a6347786864475a76636d306d5a57356a62325270626d63395a4756794d4230474131556444675157424254656b376e7664677a4e72624f3838757077734938530a64475a327654414f42674e56485138424166384542414d434273417744415944565230544151482f4241497741444343416a6b4743537147534962345451454e0a4151534341696f776767496d4d42344743697147534962345451454e4151454545454e4b662f4b51477478596d573076412b6e75626855776767466a42676f710a686b69472b453042445145434d494942557a415142677371686b69472b45304244514543415149424344415142677371686b69472b45304244514543416749420a4344415142677371686b69472b4530424451454341774942416a415142677371686b69472b4530424451454342414942416a415142677371686b69472b4530420a44514543425149424244415142677371686b69472b45304244514543426749424154415142677371686b69472b453042445145434277494241444151426773710a686b69472b4530424451454343414942426a415142677371686b69472b45304244514543435149424144415142677371686b69472b45304244514543436749420a4144415142677371686b69472b45304244514543437749424144415142677371686b69472b45304244514543444149424144415142677371686b69472b4530420a44514543445149424144415142677371686b69472b45304244514543446749424144415142677371686b69472b453042445145434477494241444151426773710a686b69472b45304244514543454149424144415142677371686b69472b4530424451454345514942437a416642677371686b69472b45304244514543456751510a43416743416751424141594141414141414141414144415142676f71686b69472b45304244514544424149414144415542676f71686b69472b453042445145450a4241594167473846414141774477594b4b6f5a496876684e4151304242516f424154416542676f71686b69472b453042445145474242446a30487552486d43480a484c4c7443467342493067654d45514743697147534962345451454e415163774e6a415142677371686b69472b45304244514548415145422f7a4151426773710a686b69472b45304244514548416745424144415142677371686b69472b45304244514548417745422f7a414b42676771686b6a4f5051514441674e4a414442470a416945416e7238516b7076757a446778572f65484c32694770724269453061444d306d6c72387a714a535331463351434951444a46354d47576a693161414c650a396879532b64354a572f642f55464c6646784f52497849775544625459413d3d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484178496a41670a42674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d45556c75644756730a49454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b474131554543417743513045780a437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f377432316c58534f0a3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553786c6d546c4a6c0a65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f536347724442530a42674e5648523845537a424a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e5648513445466751556c5739640a7a62306234656c4153636e553944504f4156634c336c517744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159420a4166384341514177436759494b6f5a497a6a30454177494452774177524149675873566b6930772b6936565947573355462f32327561586530594a446a3155650a6e412b546a44316169356343494359623153416d4435786b66545670766f34556f79695359787244574c6d5552344349394e4b7966504e2b0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"pubkey\":\"02f3bf0aaa9dd53d07ef32facc6b068421b4a7dc25e4ba3d399c5e1109c39dc45e\"}"
```